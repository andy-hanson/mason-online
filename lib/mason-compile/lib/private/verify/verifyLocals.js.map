{"version":3,"sources":["private/verify/verifyLocals.js"],"names":[],"mappings":"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","file":"private/verify/verifyLocals.js","sourcesContent":["(function (factory) {\n    if (typeof module === 'object' && typeof module.exports === 'object') {\n        var v = factory(require, exports); if (v !== undefined) module.exports = v;\n    }\n    else if (typeof define === 'function' && define.amd) {\n        define([\"require\", \"exports\", 'op/Op', '../ast/locals', '../ast/Named', '../ast/Val', '../context', '../util', './context', './util', './verifyVal'], factory);\n    }\n})(function (require, exports) {\n    \"use strict\";\n    const Op_1 = require('op/Op');\n    const locals_1 = require('../ast/locals');\n    const Named_1 = require('../ast/Named');\n    const Val_1 = require('../ast/Val');\n    const context_1 = require('../context');\n    const util_1 = require('../util');\n    const context_2 = require('./context');\n    const util_2 = require('./util');\n    const verifyVal_1 = require('./verifyVal');\n    function verifyLocalDeclare({ loc, name, opType }) {\n        Op_1.opEach(context_1.compileOptions.opBuiltinPath(name), path => {\n            context_1.warn(loc, _ => _.overriddenBuiltin(name, path));\n        });\n        Op_1.opEach(opType, verifyVal_1.default);\n    }\n    exports.verifyLocalDeclare = verifyLocalDeclare;\n    function verifyLocalAccess(_) {\n        const { loc, name } = _;\n        const declare = context_2.locals.get(name);\n        if (declare === undefined) {\n            const builtinPath = Op_1.orThrow(context_1.compileOptions.opBuiltinPath(name), () => missingLocalFail(loc, name));\n            context_2.results.accessBuiltin(name, builtinPath);\n        }\n        else {\n            context_2.results.localAccessToDeclare.set(_, declare);\n            setDeclareAccessed(declare, _);\n        }\n    }\n    exports.verifyLocalAccess = verifyLocalAccess;\n    function verifyAssign(_) {\n        if (_ instanceof locals_1.AssignSingle) {\n            const { assignee, value } = _;\n            context_2.withName(assignee.name, () => {\n                const doV = () => {\n                    if (Named_1.isNamed(value) && !(value instanceof Val_1.SpecialVal))\n                        util_2.setName(value);\n                    verifyLocalDeclare(assignee);\n                    verifyVal_1.default(value);\n                };\n                if (assignee.isLazy)\n                    withBlockLocals(doV);\n                else\n                    doV();\n            });\n        }\n        else if (_ instanceof locals_1.AssignDestructure) {\n            const { assignees, value } = _;\n            const kind = assignees[0].kind;\n            for (const _ of assignees) {\n                context_1.check(_.kind === kind, _.loc, _ => _.destructureAllLazy);\n                verifyLocalDeclare(_);\n            }\n            verifyVal_1.default(value);\n        }\n        else\n            throw new Error(_.constructor.name);\n    }\n    exports.verifyAssign = verifyAssign;\n    function deleteLocal(localDeclare) {\n        context_2.locals.delete(localDeclare.name);\n    }\n    exports.deleteLocal = deleteLocal;\n    function setLocal(localDeclare) {\n        context_2.locals.set(localDeclare.name, localDeclare);\n    }\n    exports.setLocal = setLocal;\n    function accessLocal(access, name) {\n        const declare = getLocalDeclare(name, access.loc);\n        setDeclareAccessed(declare, access);\n    }\n    exports.accessLocal = accessLocal;\n    function setDeclareAccessed(declare, access) {\n        context_2.results.localDeclareToAccesses.get(declare).push(access);\n    }\n    exports.setDeclareAccessed = setDeclareAccessed;\n    function registerLocal(localDeclare) {\n        context_2.results.localDeclareToAccesses.set(localDeclare, []);\n    }\n    exports.registerLocal = registerLocal;\n    function registerAndPlusLocal(localDeclare, action) {\n        registerLocal(localDeclare);\n        plusLocal(localDeclare, action);\n    }\n    exports.registerAndPlusLocal = registerAndPlusLocal;\n    function plusLocal(addedLocal, action) {\n        const shadowed = context_2.locals.get(addedLocal.name);\n        context_2.locals.set(addedLocal.name, addedLocal);\n        action();\n        if (shadowed === undefined)\n            deleteLocal(addedLocal);\n        else\n            setLocal(shadowed);\n    }\n    function plusLocals(addedLocals, action) {\n        const shadowedLocals = [];\n        for (const _ of addedLocals) {\n            const shadowed = context_2.locals.get(_.name);\n            if (shadowed !== undefined)\n                shadowedLocals.push(shadowed);\n            setLocal(_);\n        }\n        action();\n        addedLocals.forEach(deleteLocal);\n        shadowedLocals.forEach(setLocal);\n    }\n    exports.plusLocals = plusLocals;\n    function verifyAndPlusLocal(addedLocal, action) {\n        registerAndVerifyLocalDeclare(addedLocal);\n        plusLocal(addedLocal, action);\n    }\n    exports.verifyAndPlusLocal = verifyAndPlusLocal;\n    function verifyAndPlusLocals(addedLocals, action) {\n        addedLocals.forEach(registerAndVerifyLocalDeclare);\n        const names = new Set();\n        for (const { name, loc } of addedLocals) {\n            context_1.check(!names.has(name), loc, _ => _.duplicateLocal(name));\n            names.add(name);\n        }\n        plusLocals(addedLocals, action);\n    }\n    exports.verifyAndPlusLocals = verifyAndPlusLocals;\n    function withBlockLocals(action) {\n        const oldPendingBlockLocals = context_2.pendingBlockLocals;\n        context_2.setPendingBlockLocals([]);\n        plusLocals(oldPendingBlockLocals, action);\n        context_2.setPendingBlockLocals(oldPendingBlockLocals);\n    }\n    exports.withBlockLocals = withBlockLocals;\n    function warnUnusedLocals() {\n        for (const [local, accesses] of context_2.results.localDeclareToAccesses)\n            if (util_1.isEmpty(accesses) && local.name !== 'built' && !context_2.okToNotUse.has(local))\n                context_1.warn(local.loc, _ => _.unusedLocal(local.name));\n    }\n    exports.warnUnusedLocals = warnUnusedLocals;\n    function addImportedLocal(ld) {\n        const prev = context_2.locals.get(ld.name);\n        context_1.check(prev === undefined, ld.loc, _ => _.duplicateImport(ld.name, prev.loc));\n        registerAndVerifyLocalDeclare(ld);\n        setLocal(ld);\n    }\n    exports.addImportedLocal = addImportedLocal;\n    function registerAndVerifyLocalDeclare(_) {\n        registerLocal(_);\n        verifyLocalDeclare(_);\n    }\n    function getLocalDeclare(name, accessLoc) {\n        const declare = context_2.locals.get(name);\n        if (declare === undefined)\n            throw missingLocalFail(accessLoc, name);\n        return declare;\n    }\n    function missingLocalFail(loc, name) {\n        return context_1.fail(loc, _ => _.missingLocal(name));\n    }\n    function verifyLocalMutate({ value }) {\n        verifyVal_1.default(value);\n    }\n    exports.verifyLocalMutate = verifyLocalMutate;\n});\n"],"sourceRoot":"/source/"}